<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="project.app.dao.ReviewDao">
    <resultMap type="review" id="reviewMap">
        <result column="review_no" property="no"/>
        <result column="subject_id" property="subjectId"/>
        <result column="rate" property="rate"/>
        <result column="content" property="content"/>

        <association property="student" javaType="student">
            <id column="student_id" property="no"/>
            <result column="name" property="name"/>
        </association>

    </resultMap>

    <insert id="insert" parameterType="review">
        insert into review(student_id,subject_id,rate,content)
        values(#{student.no},#{subjectId},#{rate},#{content})
    </insert>

    <select id="list" resultType="Map">
        select
        r.subject_id as sub,
        avg(r.rate) as avg,
        count(*) as count
        from
        review r inner join student t on r.student_id=t.student_no
        group by
        r.subject_id
        order by
        r.subject_id
    </select>

    <select id="findBySubject" parameterType="int" resultMap="reviewMap">
        select
        r.review_no,
        r.subject_id,
        r.rate,
        r.content
        from
        review r inner join student t on r.student_id=t.student_no
        where
        subject_id=#{subjectNo}
        order by
        r.rate
    </select>

    <select id="findBy" parameterType="int" resultMap="reviewMap">
        select
        r.review_no,
        r.student_id,
        t.name,
        r.subject_id,
        r.rate,
        r.content
        from
        review r inner join student t on r.student_id=t.student_no
        where
        review_no=#{reviewNo}
    </select>

    <update id="update" parameterType="review">
        update review set
        rate=#{rate},
        content=#{content}
        where
        review_no=#{no}
        and student_id=#{student.no}
    </update>

    <delete id="delete" parameterType="int">
        delete from review
        where
        review_no=#{no}
    </delete>
</mapper>